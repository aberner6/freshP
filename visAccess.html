<html>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery
/1.3.2/jquery.min.js"></script>
<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>

<script type = "text/javascript" src = "http://pelars
.sssup.it:8080/pelars/auth.js"></script>
<body>
<script type="text/javascript">
var data;
var types = ["hand","ide","particle","face"];
var handData = [];

var nested_data;
var m = [15, 20, 40, 120], //top right bottom left
    w = window.innerWidth - m[1] * 2 - m[3],
    h = window.innerHeight;
var goAhead;
var svg = d3.select("body").append("svg").attr("width",w).attr("height",h);

var nest_again;
// $(document).ready(function() {
var token = "lKLCHs8DJm6a5FLrcsZLeYKrRWObG9cXy4C_TM76ZnYrht_tboNc0fsWNFP4M1ieIUH5Gdtx7Uc3IdMb30uR5HyYMKesViZC_wGuoWfkmNurhujztJTWlfDr5oD3Cs0p";
	// pelars_authenticate();
	$.getJSON( "http://pelars.sssup.it:8080/pelars/data/615/session?token="+token,function(json) { 
		// document.getElementById("id").innerHTML = JSON.stringify(json); 
		data = (json);

		nested_data = d3.nest()
			.key(function(d) { return d.type; })
			.key(function(d){ return d.num; })
			.entries(data);

		nest_again = d3.nest()
			.key(function(d) { return d.type; })
			.key(function(d){ return d.num; })
			.rollup(function(leaves) { 
				return { "max_time": d3.max(leaves, function(d) {
					return parseFloat(d.time);
					})} 
				})
			.entries(data)

		if (typeof nested_data !== "undefined"){
			console.log("yup")
			for(i=0; i<nested_data.length; i++){
				if(nested_data[i].key&&nest_again[i].key==types[0]){
					goHands(nested_data[i], nest_again[i].values);
				}
				if(nested_data[i].key&&nest_again[i].key==types[3]){
					goFace(nested_data[i], nest_again[i].values);
				}
			}	
		}
	});

var minRX, maxRX, minRY, maxRY, minFX, minFY, maxFX, maxFY;
var rx = [];
var ry = [];
var xIs = [];
var yIs = [];

var cwidth=200,cheight=200,cmargin=25,maxr=5;
var toggling = true;

var x=d3.scale.linear().range([cmargin,cwidth-cmargin]);
var y=d3.scale.linear().range([cheight-cmargin,cmargin]);
var o=d3.scale.linear().domain([0,300000]).range([.5,1]);

var fx=d3.scale.linear().range([cmargin,cwidth-cmargin]);
var fy=d3.scale.linear().range([cheight-cmargin,cmargin]);

var rows = 2;

svg.on("click", function(){
	toggling = !toggling;
	console.log(toggling)
	if(!toggling){
		d3.selectAll(".hand")
			.transition()
			.attr("transform",function(d,i) {
		  		return "translate("+cmargin+",0)";
		  	});
		d3.selectAll(".face")
			.transition()
			.attr("transform",function(d,i) {
		  		return "translate("+cmargin+",0)";
		  	});
		$(".rectText").hide();
	}
	if(toggling){
		d3.selectAll(".hand")
			.transition()
			.attr("transform",function(d,i) {
		  		return "translate("+cwidth*i+",0)";
		  	});
		d3.selectAll(".face")
			.transition()
			.attr("transform",function(d,i) {
	  		return "translate("+(cwidth*i)+","+(cheight*rows)+")";
		  	});
		$(".rectText").show();
	}
})
function goHands(incomingData, summary){	
	var toD = incomingData;
	var summary = summary;
	// One cell for each hand tracked (hands are in nested data @ at 1)
	var g = svg.selectAll(".hand")
		.data(toD.values)
		.enter()
	  	.append("g")
	  	.attr("class","hand")
	  	.attr("transform",function(d,i) {
	  		return "translate("+(cwidth*i)+",0)";
	  	});

		g
		  .append("rect")
		  .attr("x",cmargin)
		  .attr("y",cmargin)
		  .attr("width",cwidth)//-2*cmargin)
		  .attr("height",cheight)//-2*cmargin)
		  .attr("fill","none")
		  .attr("stroke","lightgray");
		// we also write its name below.
		g
		  .append("text")
		  .attr("class","rectText")
		  .attr("y",cheight+10)
		  .attr("x",cmargin)
		  .text(function(d,i) {
	  		if(d.key==summary[i].key){
	  			return (summary[i].values.max_time);
	  		}
		  })
		
		// now marks, initiated to default values
		g.selectAll("circle")
		// we are getting the values of the countries like this:
		.data(function(d) {
			return d.values;
		}) 
		.enter()
		  .append("circle")
		  .attr("cx",cmargin)
		  .attr("cy",cheight-cmargin)
		  .attr("fill","none")
		  .attr("stroke","teal")
		  .attr("r",1)
		    // throwing in a title element
		    .append("title")
		      .text(function(d) {
		      	rx.push(d.rx);
				minRX = d3.min(rx);
				maxRX = d3.max(rx);
		      	
		      	ry.push(d.ry);
				minRY = d3.min(ry);
				maxRY = d3.max(ry);

				y.domain([minRY, maxRY])
				x.domain([minRX, maxRX])
		      	// console.log(minRX);
		      	return d.num;
		      });
		 
		// finally, we animate our marks in position
		g.selectAll("circle").transition().delay(100).duration(1000)
		    .attr("r",3)
		    .attr("cx",function(d) {
		    	return x(d.rx);
		    })
		    .attr("cy",function(d) {
		    	return y(d.ry);
		    })
}

var maxtime = [];
function goFace(incomingData, summary){
	var toD = incomingData;
	var summary = summary;
	console.log(summary);
	// One cell for each face tracked (hands are in nested data @ at 1)
	var g = svg.selectAll(".face")
		.data(toD.values)
		.enter()
	  	.append("g")
	  	.attr("class","face")
	  	.attr("transform",function(d,i) {
	  		// if(d.key==summary[i].key){
	  			// console.log(summary[i].values.max_time)
	  			// maxtime.push(summary[i].values.max_time)
		  		return "translate("+(cwidth*i)+","+(cheight*rows)+")";
	  		// }
	  	});

		g
		  .append("rect")
		  // .attr("class","faceBox")
		  .attr("x",cmargin)
		  .attr("y",cmargin)
		  .attr("width",cwidth)//-2*cmargin)
		  .attr("height",cheight)//-2*cmargin)
		  .attr("fill","none")
		  .attr("stroke","lightgray");
		// we also write its name below.
		g
		  .append("text")
		  .attr("class","faceText")
		  .attr("y",cheight+10)
		  .attr("x",cmargin)
		  .text(function(d,i) {
	  		if(d.key==summary[i].key){
	  			return (summary[i].values.max_time);
	  		}
		  	// return d.values.length+" "+d.key;
		  })
		
		// now marks, initiated to default values
		g.selectAll("circle")
		// we are getting the values of the countries like this:
		.data(function(d) {
			return d.values;
		}) 
		.enter()
		  .append("circle")
		  .attr("class","faceCirc")
		  .attr("cx",cmargin)
		  .attr("cy",cheight-cmargin)
		  .attr("fill","none")
		  .attr("stroke","pink")
		  .attr("r",1)
		    // throwing in a title element
		    .append("title")
		      .text(function(d) {
		      	xIs.push(d.pos_x0+(d.pos_y0-d.pos_x0)/2);
				minFX = d3.min(xIs);
				maxFX = d3.max(xIs);
		      	
		      	yIs.push(d.pos_x1+(d.pos_y1-d.pos_x1)/2);
				minFY = d3.min(yIs);
				maxFY = d3.max(yIs);

				fy.domain([minFY, maxFY])
				fx.domain([minFX, maxFX])
		      	// console.log(minRX);
		      	return d.num;
		      });
		 
		// finally, we animate our marks in position
		g.selectAll("circle").transition().delay(100).duration(1000)
		    .attr("r",3)
		    .attr("cx",function(d) {
		    	return fx(d.pos_x0+(d.pos_y0-d.pos_x0)/2);;
		    })
		    .attr("cy",function(d) {
		    	return fy(d.pos_x1+(d.pos_y1-d.pos_x1)/2);
		    })
}
// });
</script>
</body>
</html>